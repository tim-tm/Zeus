package me.tim.features.module.impl.exploit;

import me.tim.Statics;
import me.tim.features.event.EventPacket;
import me.tim.features.event.EventUpdate;
import me.tim.features.event.api.EventTarget;
import me.tim.features.module.Category;
import me.tim.features.module.Module;
import me.tim.util.player.PlayerData;
import net.minecraft.client.entity.EntityOtherPlayerMP;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.C00PacketKeepAlive;
import net.minecraft.network.play.client.C0FPacketConfirmTransaction;
import org.lwjgl.input.Keyboard;

import java.util.ArrayList;

public class Blink extends Module {
    private final ArrayList<Packet<?>> packets;

    private EntityOtherPlayerMP blinkEntity;
    private PlayerData startData;

    public Blink() {
        super("Blink", "Blink!", Keyboard.KEY_NONE, Category.EXPLOIT);
        this.packets = new ArrayList<>();
    }

    @Override
    protected void setupSettings() { }

    @EventTarget
    private void onUpdate(EventUpdate eventUpdate) {
        if (Statics.getPlayer().isUsingItem() && Statics.getPlayer().isSneaking()) {
            Statics.getPlayer().setPositionAndRotation(this.startData.getPosX(), this.startData.getPosY(), this.startData.getPosZ(), this.startData.getYaw(), this.startData.getPitch());
            this.packets.clear();
        }
    }

    @EventTarget
    private void onPacket(EventPacket eventPacket) {
        if (eventPacket.getState().equals(EventPacket.State.RECEIVE)) return;
        if (eventPacket.getPacket() instanceof C00PacketKeepAlive || eventPacket.getPacket() instanceof C0FPacketConfirmTransaction) return;

        this.packets.add(eventPacket.getPacket());
        eventPacket.setCancelled(true);
    }

    @Override
    public void onEnable() {
        super.onEnable();
        if (Statics.getPlayer() != null) {
            this.startData = new PlayerData(Statics.getPlayer());

            this.packets.clear();
            this.blinkEntity = new EntityOtherPlayerMP(Statics.getWorld(), Statics.getPlayer().getGameProfile());
            this.blinkEntity.setPositionAndRotation(Statics.getPlayer().posX, Statics.getPlayer().posY, Statics.getPlayer().posZ, Statics.getPlayer().rotationYaw, Statics.getPlayer().rotationPitch);

            if (!Statics.getWorld().loadedEntityList.contains(this.blinkEntity))
                Statics.getWorld().addEntityToWorld(this.blinkEntity.getEntityId(), this.blinkEntity);
        }
    }

    @Override
    public void onDisable() {
        super.onDisable();
        if (Statics.getPlayer() != null) {
            for (Packet<?> packet : this.packets) {
                Statics.sendPacket(packet);
            }

            if (Statics.getWorld().loadedEntityList.contains(this.blinkEntity))
                Statics.getWorld().removeEntity(this.blinkEntity);
        }
    }
}
